trigger: none
pr: none

parameters:
- name: repoUrl
  displayName: 'Git Repo URL (paste full URL)'
  type: string
  default: ''   # empty => forces user to type during manual run

- name: branch
  displayName: 'Branch to checkout'
  type: string
  default: ''

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self
  fetchDepth: 1

- bash: |
    set -euo pipefail
    cd "$(Build.SourcesDirectory)"

    if [ -z "${{ parameters.repoUrl }}" ]; then
      echo "ERROR: repoUrl parameter is empty. Provide a repo URL when running the pipeline."
      exit 1
    fi

    if [ -z "${{ parameters.branch }}" ]; then
      echo "ERROR: branch parameter is empty. Provide a branch when running the pipeline."
      exit 1
    fi

    # Fresh clone of the target repo/branch we want to migrate
    rm -rf target
    echo "Cloning: ${{ parameters.repoUrl }}"
    echo "Branch:  ${{ parameters.branch }}"
    git clone --depth 1 --branch "${{ parameters.branch }}" "${{ parameters.repoUrl }}" target

    # IMPORTANT: Switch into the cloned repo before changing its remote
    cd target

    # Configure HTTPS remote with the GitHub token so pushes work non-interactively
    # Use the *environment variable* form: $GITHUB_TOKEN (NOT $(GITHUB_TOKEN))
    git remote set-url origin "https://${GITHUB_TOKEN}@github.com/sunidhirout88-collab/blackduck_migration_test.git"

    # Optional: show remotes (safeâ€”token is masked by ADO)
    git remote -v | sed "s/${GITHUB_TOKEN}/***MASKED***/g"

    # Back to the workspace root to run the migration script that lives in the pipeline repo
    cd "$(Build.SourcesDirectory)"

    chmod +x migration.sh
    export COMMIT_BRANCH="${{ parameters.branch }}"
    export AUTO_COMMIT="true"

    bash migration.sh "$(Build.SourcesDirectory)/target"
  displayName: "Clone repo and run migration (commit & push)"
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
