trigger: none
pr: none

parameters:
- name: repoUrl
  displayName: 'Git Repo URL (paste full URL)'
  type: string
  default: ''   # empty => forces user to type during manual run

- name: branch
  displayName: 'Branch to checkout'
  type: string
  default: ''

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self
  fetchDepth: 1

- bash: |
    set -Eeuo pipefail
    trap 'code=$?; echo "ERROR on line ${LINENO} (cmd: ${BASH_COMMAND}) -> $code"; exit $code' ERR
    set -x
    set -euo pipefail
    cd "$(Build.SourcesDirectory)"

    if [ -z "${{ parameters.repoUrl }}" ]; then
      echo "ERROR: repoUrl parameter is empty. Provide a repo URL when running the pipeline."
      exit 1
    fi

    if [ -z "${{ parameters.branch }}" ]; then
      echo "ERROR: branch parameter is empty. Provide a branch when running the pipeline."
      exit 1
    fi

    rm -rf target
    echo "Cloning: ${{ parameters.repoUrl }}"
    echo "Branch:  ${{ parameters.branch }}"
    git clone --depth 1 --branch "${{ parameters.branch }}" "${{ parameters.repoUrl }}" target
    echo "Clone result: $?"
    test -d target && echo "target dir exists" && ls -la target
    ls -la "$(Build.SourcesDirectory)"
    test -f migration.sh || { echo "migration.sh not found"; exit 1; }
    chmod +x migration.sh
    bash migration.sh "$(Build.SourcesDirectory)/target"
    cd "$(Build.SourcesDirectory)/target"

    # Show changes (if any)
    git status --porcelain

    CHANGES=$(git status --porcelain | wc -l)
    if [ "$CHANGES" -gt 0 ]; then
       git config user.name  "azure-pipelines-bot"
       git config user.email "azure-pipelines-bot@users.noreply.github.com"
       git add -A
       git commit -m "Migrate Polaris â†’ Black Duck (Bridge CLI) [automated]"

      : "${GITHUB_TOKEN:?Set a secret variable GITHUB_TOKEN with repo:write rights}"
      ORIGIN_URL=$(git remote get-url origin)
      ORIGIN_URL_PUSH="${ORIGIN_URL/https:\/\//https:\/\/x-access-token:${GITHUB_TOKEN}@}"

      git remote set-url origin "$ORIGIN_URL_PUSH"
      git push origin "HEAD:${{ parameters.branch }}"
      echo "Pushed changes to ${{ parameters.branch }}"
  else
      echo "No changes to commit."
  fi
  ``
  displayName: "Clone repo and run migration (commit & push)"
  env:
    # Secret PAT for GitHub push (Azure DevOps recommends secret vars over CLI args) [1](https://www.geeksforgeeks.org/python/how-to-define-and-call-a-function-in-python/)
    GITHUB_TOKEN: $(GITHUB_TOKEN)
    # Needed so the script knows which branch to push to
    TARGET_BRANCH: ${{ parameters.branch }}
